(function(){
'use strict';CindyJS.registerPlugin(1,"audio",function(c){var d=null,e=null,f=null,v=null,p=[null,null],u=null,z=0,r=[null,null],k=[null,null],A=[null,null],l=[null,null],m=[null,null],B=[null,null],h=[null,null],n=0,g=null,w=null,t=null,C=function(){null==e&&(e=new (window.AudioContext||window.webkitAudioContext))},F=function(){null==u&&(u=e.createScriptProcessor(2048,f.buffer.numberOfChannels,f.buffer.numberOfChannels),u.onaudioprocess=function(a){for(a=0;a<f.buffer.numberOfChannels;++a){p[a].getFloatFrequencyData(r[a]);
var b=a;if(null!=k[b])for(var q=0;256>q;++q){var c=r[b][1024*q/256];c=Math.min(-30,Math.max(-100,c));c=Math.floor((c- -100)/70*256);for(var e=255,d=255,x=0;256>x;++x){var y=4*(256*(255-x)+q);x==c&&(e=d=0);l[b].data[y+0]=e;l[b].data[y+1]=d;l[b].data[y+2]=0;l[b].data[y+3]=255}}if(null!=m[b])for(q=0;256>q;++q)c=4*(256*(255-q)+n),e=r[b][1024*q/256],e=Math.min(-30,Math.max(-100,e)),e=(g.height-1-Math.floor((e- -100)/70*(g.height-1)))*g.width*4,h[b].data[c+0]=t.data[e+0],h[b].data[c+1]=t.data[e+1],h[b].data[c+
2]=t.data[e+2],h[b].data[c+3]=255}n=(n+1)%256})},D=function(a){null==f&&(f=e.createBufferSource(),f.buffer=a,f.loop=!0,console.log("rate = "+f.buffer.sampleRate),console.log("duration = "+f.buffer.duration),console.log("channels = "+f.buffer.numberOfChannels));null==v&&(v=e.createChannelSplitter(f.buffer.numberOfChannels));for(a=0;a<f.buffer.numberOfChannels;++a)null==p[a]&&(p[a]=e.createAnalyser(),p[a].smoothingTimeConstant=0,p[a].fftSize=2048,p[a].minDecibels=-100,p[a].maxDecibels=-30);for(a=0;2>
a;++a)null==r[a]&&(r[a]=new Float32Array(1024));F();if(null==g){g=document.createElement("canvas");g.id="audiocolormap";g.style.display="none";g.width=10;g.height=256;w=g.getContext("2d");for(a=0;a<g.height;++a)w.fillStyle="hsl("+240*a/g.height+", 100%, 50%)",w.fillRect(0,a,g.width,1);t=w.getImageData(0,0,g.width,g.height)}for(a=0;2>a;++a){var b=a;null==k[b]&&(k[b]=document.createElement("canvas"),k[b].id="audiocanvassp"+b,k[b].style.display="none",k[b].width=256,k[b].height=256,A[b]=k[b].getContext("2d"),
l[b]=A[b].getImageData(0,0,256,256));null==m[b]&&(m[b]=document.createElement("canvas"),m[b].id="audiocanvasspgr"+b,m[b].style.display="none",m[b].width=256,m[b].height=256,B[b]=m[b].getContext("2d"),h[b]=B[b].getImageData(0,0,256,256));b=a;if(null!=k[b])for(var c=0;262144>c;c+=4)l[b].data[c+0]=0,l[b].data[c+1]=0,l[b].data[c+2]=0,l[b].data[c+3]=255;if(null!=m[b]){c=(g.height-1)*g.width*4;for(var d=0;262144>d;d+=4)h[b].data[d+0]=t.data[c+0],h[b].data[d+1]=t.data[c+1],h[b].data[d+2]=t.data[c+2],h[b].data[d+
3]=255}}n=0;f.connect(v);for(a=0;a<f.buffer.numberOfChannels;++a)v.connect(p[a],a);f.connect(u);u.connect(e.destination);f.connect(e.destination);z=e.currentTime;f.start(0)},G=function(a){if(null==f){console.log("id "+a);a=document.getElementById(a).files[0];console.log("loading "+a.name);var b=new FileReader;b.onload=function(){C();e.decodeAudioData(b.result,function(a){D(a)},function(a){console.log("decodeAudioData failed")})};b.readAsArrayBuffer(a)}},H=function(a){if(null==f){console.log("loading "+
a);var b=new XMLHttpRequest;b.open("GET",a,!0);b.responseType="arraybuffer";b.onerror=function(){console.log("XMLHttpRequest failed")};b.onload=function(){C();e.decodeAudioData(this.response,function(a){D(a)},function(a){console.log("decodeAudioData failed")})};b.send()}},E=function(a,b){a=c.instance.canvas.clientWidth;var e=c.instance.canvas.clientHeight,d=c.getInitialMatrix(),f=function(a,b,c){b-=a.tx;c+=a.ty;return{x:(b*a.d-c*a.b)/a.det,y:-(-b*a.c+c*a.a)/a.det}},g=f(d,0,0),h=f(d,0,e);d=f(d,a,e);
return[Math.abs((b.x-h.x)/(d.x-h.x))*a,Math.abs((g.y-b.y)/(g.y-h.y))*e]};c.defineFunction("playaudio",1,function(a,b){a=c.evaluate(a[0]);if("string"!==a.ctype)return c.nada;a.value.startsWith("file://")?G(a.value.substr(7)):H(a.value);return c.nada});c.defineFunction("stopaudio",0,function(a,b){if(null!=f)return f.stop(),e.close(),v=f=e=null,p=[null,null],u=null,c.nada});c.defineFunction("audiospectrum",2,function(a,b){b=-100;var d=c.evaluate(a[0]);"number"==d.ctype&&null!=r[d.value.real]&&(a=c.evaluate(a[1]),
"number"==a.ctype&&(b=r[d.value.real][a.value.real]));return{ctype:"number",value:{real:b,imag:0}}});c.defineFunction("audiodrawspectrum",2,function(a,b){b=c.evaluate(a[1]);if("number"!=b.ctype)return c.nada;b=b.value.real;a=c.extractPoint(c.evaluateAndVal(a[0]));a=E(b,a);if(null==d&&(d=c.instance.canvas.getContext("2d"),null==d))return c.nada;if(null==k[b])return d.fillStyle="black",d.fillRect(a[0],a[1],256,256),c.nada;d.putImageData(l[b],a[0],a[1]);return c.nada});c.defineFunction("audiodrawspectrogram",
2,function(a,b){b=c.evaluate(a[1]);if("number"!=b.ctype)return c.nada;b=b.value.real;a=c.extractPoint(c.evaluateAndVal(a[0]));a=E(b,a);if(null==d&&(d=c.instance.canvas.getContext("2d"),null==d))return c.nada;if(null==m[b])return d.fillStyle="hsl(240, 100%, 50%)",d.fillRect(a[0],a[1],256,256),c.nada;d.putImageData(h[b],a[0]-n,a[1],n,0,256-n,256);0<n&&d.putImageData(h[b],a[0]+256-n,a[1],0,0,n,256);return c.nada});c.defineFunction("audioposition",0,function(a,b){a=0;null!=f&&(a=e.currentTime-z);return{ctype:"number",
value:{real:a,imag:0}}})});
}).call(this);

