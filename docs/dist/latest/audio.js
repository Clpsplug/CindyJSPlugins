(function(){
'use strict';CindyJS.registerPlugin(1,"audio",function(a){var f=null,e=null,v=null,p=[null,null],u=null,y=0,t=[null,null],k=[null,null],z=[null,null],n=[null,null],l=[null,null],A=[null,null],m=[null,null],q=0,g=null,w=null,r=null,C=function(){null==u&&(u=f.createScriptProcessor(2048,e.buffer.numberOfChannels,e.buffer.numberOfChannels),u.onaudioprocess=function(d){for(d=0;d<e.buffer.numberOfChannels;++d){p[d].getFloatFrequencyData(t[d]);var c=d;if(null!=k[c])for(var h=0;256>h;++h){var b=t[c][1024*
h/256];b=Math.min(-30,Math.max(-100,b));b=Math.floor((b- -100)/70*256);for(var a=255,B=255,x=0;256>x;++x){var f=4*(256*(255-x)+h);x==b&&(a=B=0);n[c].data[f+0]=a;n[c].data[f+1]=B;n[c].data[f+2]=0;n[c].data[f+3]=255}}if(null!=l[c])for(h=0;256>h;++h)b=4*(256*(255-h)+q),a=t[c][1024*h/256],a=Math.min(-30,Math.max(-100,a)),a=(g.height-1-Math.floor((a- -100)/70*(g.height-1)))*g.width*4,m[c].data[b+0]=r.data[a+0],m[c].data[b+1]=r.data[a+1],m[c].data[b+2]=r.data[a+2],m[c].data[b+3]=255}q=(q+1)%256})},D=function(a){console.log("loading "+
a);var c=new XMLHttpRequest;c.open("GET",a,!0);c.responseType="arraybuffer";c.onload=function(){f.decodeAudioData(this.response,function(a){null==e&&(e=f.createBufferSource(),e.buffer=a,e.loop=!0);if(null!=e){console.log("rate = "+e.buffer.sampleRate);console.log("duration = "+e.buffer.duration);console.log("channels = "+e.buffer.numberOfChannels);null==v&&(v=f.createChannelSplitter(e.buffer.numberOfChannels));for(a=0;a<e.buffer.numberOfChannels;++a)null==p[a]&&(p[a]=f.createAnalyser(),p[a].smoothingTimeConstant=
0,p[a].fftSize=2048,p[a].minDecibels=-100,p[a].maxDecibels=-30,t[a]=new Float32Array(1024));C();for(a=0;a<e.buffer.numberOfChannels;++a){var b=a;null==k[b]&&(k[b]=document.createElement("canvas"),k[b].id="audiocanvassp"+b,k[b].style.display="none",k[b].width=256,k[b].height=256,z[b]=k[b].getContext("2d"),n[b]=z[b].getImageData(0,0,256,256));null==l[b]&&(l[b]=document.createElement("canvas"),l[b].id="audiocanvasspgr"+b,l[b].style.display="none",l[b].width=256,l[b].height=256,A[b]=l[b].getContext("2d"),
m[b]=A[b].getImageData(0,0,256,256));b=a;if(null!=k[b])for(var c=0;262144>c;c+=4)n[b].data[c+0]=0,n[b].data[c+1]=0,n[b].data[c+2]=0,n[b].data[c+3]=255;if(null!=l[b]){c=(g.height-1)*g.width*4;for(var d=0;262144>d;d+=4)m[b].data[d+0]=r.data[c+0],m[b].data[d+1]=r.data[c+1],m[b].data[d+2]=r.data[c+2],m[b].data[d+3]=255}}q=0;e.connect(v);for(a=0;a<e.buffer.numberOfChannels;++a)v.connect(p[a],a);e.connect(u);u.connect(f.destination);e.connect(f.destination);y=f.currentTime;e.start(0)}},function(a){console.log("decodeAudioData failed")})};
c.onerror=function(){console.log("XMLHttpRequest failed")};c.send()};a.defineFunction("playaudio",1,function(d,c){if(null!=e)return a.nada;d=a.evaluate(d[0]);if("string"!==d.ctype)return a.nada;null==f&&(f=new (window.AudioContext||window.webkitAudioContext));D(d.value);return a.nada});a.defineFunction("stopaudio",0,function(d,c){return a.nada});a.defineFunction("audiospectrum",2,function(d,c){c=-100;var h=a.evaluate(d[0]);"number"==h.ctype&&null!=t[h.value.real]&&(d=a.evaluate(d[1]),"number"==d.ctype&&
(c=t[h.value.real][d.value.real]));return{ctype:"number",value:{real:c,imag:0}}});a.defineFunction("audioinitfft",0,function(d,c){if(null!=e)return a.nada;g=document.createElement("canvas");g.id="audiocolormap";g.style.display="none";g.width=10;g.height=256;w=g.getContext("2d");for(d=0;d<g.height;++d)w.fillStyle="hsl("+240*d/g.height+", 100%, 50%)",w.fillRect(0,d,g.width,1);r=w.getImageData(0,0,g.width,g.height);return a.nada});a.defineFunction("audiodrawspectrum",2,function(d,c){c=a.evaluate(d[1]);
if("number"!=c.ctype)return a.nada;c=c.value.real;var h=a.instance.canvas.getContext("2d");if(null==h)return a.nada;var b=a.instance.canvas.clientWidth,e=a.instance.canvas.clientHeight,f=a.getInitialMatrix(),g=function(a,b,c){b-=a.tx;c+=a.ty;return{x:(b*a.d-c*a.b)/a.det,y:-(-b*a.c+c*a.a)/a.det}},m=g(f,0,0),l=g(f,0,e);f=g(f,b,e);d=a.extractPoint(a.evaluateAndVal(d[0]));b*=Math.abs((d.x-l.x)/(f.x-l.x));e*=Math.abs((m.y-d.y)/(m.y-l.y));if(null==k[c])return h.fillStyle="black",h.fillRect(b,e,256,256),
a.nada;h.putImageData(n[c],b,e);return a.nada});a.defineFunction("audiodrawspectrogram",2,function(d,c){c=a.evaluate(d[1]);if("number"!=c.ctype)return a.nada;var e=a.instance.canvas.getContext("2d");if(null==e)return a.nada;var b=a.instance.canvas.clientWidth,f=a.instance.canvas.clientHeight,g=a.getInitialMatrix(),k=function(a,b,c){b-=a.tx;c+=a.ty;return{x:(b*a.d-c*a.b)/a.det,y:-(-b*a.c+c*a.a)/a.det}},n=k(g,0,0),p=k(g,0,f);g=k(g,b,f);d=a.extractPoint(a.evaluateAndVal(d[0]));b*=Math.abs((d.x-p.x)/
(g.x-p.x));f*=Math.abs((n.y-d.y)/(n.y-p.y));c=c.value.real;if(null==l[c])return e.fillStyle="hsl(240, 100%, 50%)",e.fillRect(b,f,256,256),a.nada;e.putImageData(m[c],b-q,f,q,0,256-q,256);0<q&&e.putImageData(m[c],b+256-q,f,0,0,q,256);return a.nada});a.defineFunction("audioposition",0,function(a,c){a=0;null!=e&&(a=f.currentTime-y);return{ctype:"number",value:{real:a,imag:0}}})});
}).call(this);

